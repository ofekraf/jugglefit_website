{% extends "macros/base.html" %}

{% block head %}
<script>
// Trick filtering constants from Flask context
const MIN_TRICK_PROPS_COUNT = {{ MIN_TRICK_PROPS_COUNT }};
const MAX_TRICK_PROPS_COUNT = {{ MAX_TRICK_PROPS_COUNT }};
const MIN_TRICK_DIFFICULTY = {{ MIN_TRICK_DIFFICULTY }};
const MAX_TRICK_DIFFICULTY = {{ MAX_TRICK_DIFFICULTY }};
</script>
<script>
// Make props settings available globally for macros
const propsSettings = {{ props_settings|tojson|safe }};
window.propsSettings = propsSettings;
</script>
<script>
// Ensure currentRoute is defined to avoid ReferenceError
if (typeof currentRoute === 'undefined') {
    var currentRoute = { name: '', duration_seconds: 600, prop: '', tricks: [] };
}
</script>
<script>
// Expose initial_route from Flask as window.initialRoute for JS
window.initialRoute = {{ initial_route|tojson|safe }};
</script>
{% endblock %}

{% block title %}Create Your Own Route{% endblock %}
{% block content %}
<div class="route-page">
    <div class="route-header">
        <h1 class="route-title">Build Your Route</h1>
        <div class="route-description">
            <p>Create a custom route by selecting tricks.</p>
        </div>
        <div class="siteswap-x-toggle-row center-row">
            <label class="siteswap-x-toggle-label">
                <input type="checkbox" id="toggle-siteswap-x-checkbox" class="siteswap-x-toggle-checkbox"> Siteswap-X
            </label>
        </div>
    </div>

    {% from 'macros/route_name_input.html' import route_name_input %}
    {% from 'macros/prop_selection_macro.html' import prop_selection_macro %}
    {% from 'macros/number_of_props_macro.html' import number_of_props_macro %}
    {% from 'macros/difficulty_range_macro.html' import difficulty_range_macro %}
    {% from 'macros/route_duration_macro.html' import route_duration_macro %}
    {% from 'macros/limit_max_throw_macro.html' import limit_max_throw_macro %}
    {% from 'macros/relevant_tags_macro.html' import relevant_tags_macro %}
    {% from 'macros/available_tricks_macro.html' import available_tricks_macro %}
    {% from 'macros/route_initialization_macro.html' import route_initialization_macro %}

    <div class="route-form">
        {{ route_name_input() }}
        {{ route_duration_macro() }}

        {{ prop_selection_macro(props_settings, main_props, initial_route.prop if initial_route else None) }}

        <!-- Route Display -->
        <div class="form-section">
            <div class="route-container">
                <div class="route-content">
                    {% if initial_route %}
                        {% set route = initial_route %}
                        {% include "macros/route_display.html" %}
                    {% else %}
                        <div id="route-sections" class="route-sections"></div>
                    {% endif %}
                </div>
            </div>
            <div class="route-actions">
                <div class="route-buttons">
                    <button type="button" id="view_route" class="primary-button">View Route</button>
                </div>
            </div>
        </div>

        <!-- Add Custom Trick Section -->
        <div class="form-section custom-trick-section">
            <h4 class="subsection-title">Add Custom Trick</h4>
            <div class="custom-trick-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="custom_trick_name">Trick Name</label>
                        <input type="text" id="custom_trick_name" class="form-input" placeholder="Enter trick name">
                    </div>
                    <div class="form-group">
                        <label for="custom_trick_props">Number of Props</label>
                        <div class="slider-container">
                            <div class="slider-wrapper">
                                <input type="range" id="custom_trick_props" class="custom-range" min="1" max="{{ MAX_TRICK_PROPS_COUNT }}" value="3">
                                <span id="custom_trick_props_value" class="slider-value">3</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="custom_trick_comment">Comment (Optional)</label>
                    <textarea id="custom_trick_comment" class="form-input" placeholder="Add a comment about the trick"></textarea>
                </div>
                <button type="button" id="add_custom_trick" class="add-trick">Add</button>
            </div>
        </div>

        <div class="form-section">
            <div class="route-form">
                <h4 class="subsection-title">Add Tricks</h4>
                <label class="form-label">Available Tricks</label>

                {{ number_of_props_macro() }}
                {{ difficulty_range_macro() }}
                {{ limit_max_throw_macro(props_settings) }}
                {{ relevant_tags_macro(tag_category_map, 'available') }}
                {{ available_tricks_macro() }}
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast-notification"></div>

<!-- Include noUISlider CSS and JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="{{ url_for('static', filename='js/general.js') }}"></script>
<script src="{{ url_for('static', filename='js/siteswap_x.js') }}"></script>

<script type="module">
    console.log('Module script starting...');
    try {
        const { fetchTricks, updatePropsSliderRange, updateRelevantTags, setMaxThrowForProp, initMaxThrowBindings, initializePropSelection, updateRouteDisplay, addTrickToRoute, removeTrick, updateCustomTrickPropsRange } = await import("{{ url_for('static', filename='js/route_helpers.js') }}");
        console.log('Route helpers imported successfully');
        
        // Make functions available globally for non-module scripts and macros
        window.fetchTricks = fetchTricks;
        window.updateRelevantTags = updateRelevantTags;
        window.setMaxThrowForProp = setMaxThrowForProp;
        window.updatePropsSliderRange = updatePropsSliderRange;
        window.initializePropSelection = initializePropSelection;
        window.updateRouteDisplay = updateRouteDisplay;
        window.addTrickToRoute = addTrickToRoute;
        window.removeTrick = removeTrick;
        window.updateCustomTrickPropsRange = updateCustomTrickPropsRange;
        console.log('Functions exposed to window');
        
        // Initialize max throw bindings
        initMaxThrowBindings();
        console.log('Max throw bindings initialized');
        
        // Trigger initial prop setup after functions are available
        setTimeout(() => {
            console.log('Triggering initial prop setup from module...');
            const event = new CustomEvent('routeHelpersReady');
            document.dispatchEvent(event);
        }, 50);
        
    } catch (error) {
        console.error('Failed to import route helpers:', error);
    }
</script>

<!-- Route initialization macro with all the complex logic -->
    {{ route_initialization_macro() }}

<script>
// Simple manual trick loading test
setTimeout(() => {
    console.log('=== MANUAL TRICK LOADING TEST ===');
    console.log('fetchTricks available:', typeof window.fetchTricks === 'function');
    console.log('UpdateAvailableTricks available:', typeof window.UpdateAvailableTricks === 'function');
    
    const selectedProp = document.querySelector('.prop-option-input:checked');
    console.log('Selected prop:', selectedProp ? selectedProp.value : 'none');
    
    if (selectedProp && typeof window.fetchTricks === 'function') {
        console.log('Manually triggering fetchTricks for:', selectedProp.value);
        window.fetchTricks({ propType: selectedProp.value })
            .then(tricks => {
                console.log('Manual fetch SUCCESS:', tricks.length, 'tricks loaded');
                window.allTricks = tricks;
                if (typeof window.UpdateAvailableTricks === 'function') {
                    console.log('Calling UpdateAvailableTricks manually');
                    window.UpdateAvailableTricks();
                } else {
                    console.log('UpdateAvailableTricks not available');
                }
            })
            .catch(error => {
                console.error('Manual fetch FAILED:', error);
            });
    } else {
        console.log('Cannot trigger manual fetch - missing prop or function');
    }
}, 1000);
</script>
</div>
{% endblock %}

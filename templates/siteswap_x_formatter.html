{% extends "macros/base.html" %}

{% block title %}Siteswap X Formatter{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="section">
    <div class="section-container">
        <h1 class="section-title">Siteswap X Formatter</h1>
        <p class="lead">Type a siteswap-x string to see it formatted.</p>
        
        <div class="form-group">
            <label for="siteswap-input">Raw Siteswap X:</label>
            <input type="text" id="siteswap-input" class="form-control" placeholder="e.g. 4{/Rs}23{B}" autocomplete="off" style="font-size: 1.2em; padding: 10px;">
        </div>

        <div class="mt-4">
            <h3>Formatted Result:</h3>
            <div class="trick-container trick-widget" style="display: inline-block; padding: 20px;">
                <div class="trick-main">
                    <span id="formatted-output" class="trick-siteswap-x" style="font-size: 3em;"></span>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button class="primary-button" onclick="sharePattern()">Share</button>
        </div>

        <div class="mt-5 pt-5 border-top" style="margin-top: 50px !important;">
            <h3>Example:</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Raw:</strong></p>
                    <p><code style="font-size: 1.2em;">4{/Rs}23{B}</code></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Formatted:</strong></p>
                    <div class="trick-container trick-widget" style="display: inline-block; padding: 10px;">
                        <div class="trick-main">
                            <span id="static-example-output" class="trick-siteswap-x" style="font-size: 2em;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/siteswap_x.js') }}"></script>
<script>
    const input = document.getElementById('siteswap-input');
    const output = document.getElementById('formatted-output');
    const staticExampleOutput = document.getElementById('static-example-output');

    function updateFormat() {
        const raw = input.value;
        output.innerHTML = formatSiteswapX(raw);
    }

    input.addEventListener('input', updateFormat);
    
    // Load pattern from URL parameter if present
    function loadPatternFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const pattern = urlParams.get('pattern');
        if (pattern) {
            try {
                // Decode from base64
                const decoded = atob(pattern);
                input.value = decoded;
                updateFormat();
            } catch (e) {
                console.error('Failed to decode pattern:', e);
                // Fallback to treating it as regular URL-encoded string
                input.value = decodeURIComponent(pattern);
                updateFormat();
            }
        }
    }

    // Share Pattern functionality
    async function sharePattern() {
        const shareBtn = document.querySelector('button[onclick="sharePattern()"]');
        const originalText = shareBtn.textContent;
        shareBtn.textContent = 'Copying...';
        shareBtn.disabled = true;

        try {
            // Encode pattern as base64
            const pattern = btoa(input.value);
            const baseUrl = window.location.origin + window.location.pathname;
            const urlToShare = `${baseUrl}?pattern=${pattern}`;
            
            await navigator.clipboard.writeText(urlToShare);
            showToast('URL copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy URL: ', err);
            showToast('Failed to copy URL. Please try again.');
        } finally {
            shareBtn.textContent = originalText;
            shareBtn.disabled = false;
        }
    }

    // Toast notification function
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Show the toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        // Hide and remove the toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }

    // Load pattern from URL on page load
    loadPatternFromURL();
    
    // Initial call
    updateFormat();

    // Render static example
    if (staticExampleOutput) {
        staticExampleOutput.innerHTML = formatSiteswapX('4{/Rs}23{B}');
    }
</script>
{% endblock %}
